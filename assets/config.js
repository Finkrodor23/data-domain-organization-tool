
const UI={handle:null,xml:null,data:null};
function parseConfigXML(text){const doc=new DOMParser().parseFromString(text,'application/xml');if(doc.querySelector('parsererror'))throw new Error('Bad ui-config.xml');const T=(s,d='')=>{const n=doc.querySelector(s);return n?n.textContent.trim():d};function stops(){return Array.from(doc.querySelectorAll('theme heatmap stop')).map(s=>({at:Number(s.getAttribute('at')),color:s.getAttribute('color')})).sort((a,b)=>a.at-b.at)};const vocab=s=>Array.from(doc.querySelectorAll(s+' > value')).map(n=>n.textContent.trim());return{version:doc.querySelector('meta > version')?.getAttribute('id')||'u0000',theme:{background:{from:T('theme > background > from','#0a0e12'),to:T('theme > background > to','#0c1116'),accent:T('theme > background > accent','#00bc66')},colors:{card:T('theme > colors > card','#131923'),line:T('theme > colors > line','#202a36'),text:T('theme > colors > text','#f1f5f9'),muted:T('theme > colors > muted','#9aa7b3')},heatmap:stops(),layout:{domainColumns:Number(T('theme > layout > domainColumns','5'))}},vocab:{storages:vocab('vocabularies > storages'),ingestions:vocab('vocabularies > ingestions'),frontends:vocab('vocabularies > frontends')},_doc:doc};}
function applyTheme(cfg){const r=document.documentElement;r.style.setProperty('--accent',cfg.theme.background.accent);r.style.setProperty('--card',cfg.theme.colors.card);r.style.setProperty('--line',cfg.theme.colors.line);r.style.setProperty('--fg',cfg.theme.colors.text);r.style.setProperty('--muted',cfg.theme.colors.muted);document.body.style.background=`linear-gradient(180deg, ${cfg.theme.background.from} 0%, ${cfg.theme.background.to} 100%)`;const g=document.querySelector('.grid-domains');if(g){const c=Math.max(1,Math.min(6,cfg.theme.layout.domainColumns||5));g.style.gridTemplateColumns=`repeat(${c},minmax(260px,1fr))`;}};
async function loadDefaultUIConfig(){try{const r=await fetch('./assets/ui-config.xml',{cache:'no-store'});if(r.ok){const t=await r.text();UI.xml=new DOMParser().parseFromString(t,'application/xml');UI.data=parseConfigXML(t);applyTheme(UI.data);if(window.setStatus)setStatus(`Loaded ui-config ${UI.data.version}`)}}catch(e){if(window.setStatus)setStatus('No ui-config.xml found')}}
async function openUIConfig(){try{const[h]=await window.showOpenFilePicker({types:[{description:'XML',accept:{'text/xml':['.xml']}}]});UI.handle=h;const t=await (await h.getFile()).text();UI.xml=new DOMParser().parseFromString(t,'application/xml');UI.data=parseConfigXML(t);applyTheme(UI.data);if(window.setStatus)setStatus(`Opened ui-config ${UI.data.version}`)}catch(e){if(e.name!=='AbortError')alert('Open ui-config failed: '+e.message)}}
function serializeUIConfig(d){const i=n=>'  '.repeat(n),e=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;');let o=`<?xml version="1.0" encoding="UTF-8"?>\n<uiConfig>\n`;o+=`${i(1)}<meta>\n${i(2)}<version id="${d.version||'u0000'}"/>\n${i(2)}<updated>${new Date().toISOString()}</updated>\n${i(1)}</meta>\n`;o+=`${i(1)}<theme>\n${i(2)}<background mode="gradient">\n${i(3)}<from>${d.theme.background.from}</from>\n${i(3)}<to>${d.theme.background.to}</to>\n${i(3)}<accent>${d.theme.background.accent}</accent>\n${i(2)}</background>\n${i(2)}<colors>\n${i(3)}<card>${d.theme.colors.card}</card>\n${i(3)}<line>${d.theme.colors.line}</line>\n${i(3)}<text>${d.theme.colors.text}</text>\n${i(3)}<muted>${d.theme.colors.muted}</muted>\n${i(2)}</colors>\n${i(2)}<heatmap>\n`;for(const s of d.theme.heatmap){o+=`${i(3)}<stop at="${s.at}" color="${s.color}"/>\n`;}o+=`${i(2)}</heatmap>\n${i(2)}<layout>\n${i(3)}<domainColumns>${d.theme.layout.domainColumns||5}</domainColumns>\n${i(2)}</layout>\n${i(1)}</theme>\n${i(1)}<vocabularies>\n`;const p=(n,a)=>{o+=`${i(2)}<${n}>\n`;for(const v of a)o+=`${i(3)}<value>${e(v)}</value>\n`;o+=`${i(2)}</${n}>\n`};p('storages',UI.data.vocab.storages||[]);p('ingestions',UI.data.vocab.ingestions||[]);p('frontends',UI.data.vocab.frontends||[]);o+=`${i(1)}</vocabularies>\n</uiConfig>\n`;return o;}
async function saveUIConfig(){if(!UI.data)return alert('No UI config loaded');try{const ts=new Date().toISOString().replace(/[-:.]/g,'').slice(0,15);UI.data.version='u'+ts;const xml=serializeUIConfig(UI.data);if(UI.handle){const w=await UI.handle.createWritable();await w.write(xml);await w.close()}else{const h=await window.showSaveFilePicker({suggestedName:'assets/ui-config.xml',types:[{description:'XML',accept:{'text/xml':['.xml']}}]});UI.handle=h;const w=await h.createWritable();await w.write(xml);await w.close()}applyTheme(UI.data);if(window.setStatus)setStatus(`Saved ui-config ${UI.data.version}`)}catch(e){alert('Save ui-config failed: '+e.message)}}
function colorAt(v){const s=(UI.data?.theme?.heatmap)||[{at:0,color:'#ff4d4f'},{at:50,color:'#ffd666'},{at:100,color:'#52c41a'}];v=Math.max(0,Math.min(100,Number(v)||0));let a=s[0],b=s[s.length-1];for(let i=0;i<s.length-1;i++){const s1=s[i],s2=s[i+1];if(v>=s1.at&&v<=s2.at){a=s1;b=s2;break}}const t=(v-a.at)/(b.at-a.at||1);const c=h=>{const n=h.replace('#','');return[parseInt(n.slice(0,2),16),parseInt(n.slice(2,4),16),parseInt(n.slice(4,6),16)]};const ca=c(a.color),cb=c(b.color),mix=i=>Math.round(ca[i]+(cb[i]-ca[i])*t);return`rgb(${mix(0)}, ${mix(1)}, ${mix(2)})`}
